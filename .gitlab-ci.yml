stages:
  - validate
  - sync

validate-merge-policy:
  stage: validate
  image: alpine:latest
  rules:
    # Run only for merge requests
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: always
    - when: never
  script:
    - |
      echo "Validating merge policy"
      echo "Source branch: $CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
      echo "Target branch: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

      SRC="$CI_MERGE_REQUEST_SOURCE_BRANCH_NAME"
      TGT="$CI_MERGE_REQUEST_TARGET_BRANCH_NAME"

      # ---- public branch rules ----
      if [ "$TGT" = "github-public" ]; then
        if [ "$SRC" != "develop" ]; then
          echo "ERROR: Only 'develop' may be merged into 'github-public'"
          exit 1
        fi
      fi

      # ---- develop branch rules ----
      if [ "$TGT" = "develop" ]; then
        if [ "$SRC" = "local" ] || [ "$SRC" = "github-public" ]; then
          echo "ERROR: 'local' or 'github-public' must never be merged into 'develop'"
          exit 1
        fi
      fi

      # ---- local branch rules ----
      if [ "$TGT" = "local" ]; then
        if [ "$SRC" = "github-public" ] || [ "$SRC" = "develop" ]; then
          echo "ERROR: 'local' must not receive merges from 'github-public' or 'develop'"
          echo "Use rebase instead."
          exit 1
        fi
      fi

      echo "Merge policy validation passed."

sync-public-to-github:
  stage: sync
  image: alpine:latest
  rules:
    - if: '$CI_COMMIT_BRANCH == "github-public"'
      when: on_success
    - when: never
  before_script:
    - apk add --no-cache git openssh
    - mkdir -p ~/.ssh
    - echo "$GITHUB_SSH_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan github.com >> ~/.ssh/known_hosts
    - git config --global user.name "GitLab Sync Bot"
    - git config --global user.email "sync@gitlab.pbrg.hu"
  script:
    - git remote add github "$GITHUB_REPO" || git remote set-url github "$GITHUB_REPO"
    - git push github github-public:main --force-with-lease